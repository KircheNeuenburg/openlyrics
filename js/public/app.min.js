!function(e,n,o,i,r){"use strict";var s=e.module("OpenLP",["restangular","ngRoute"]).config(["$provide","$routeProvider","RestangularProvider","$httpProvider","$windowProvider",function(e,n,t,i,r){i.defaults.headers.common.requesttoken=o,e.value("Constants",{saveInterval:5e3}),n.when("/songs/:songId",{templateUrl:"song.html",controller:"SongController",resolve:{song:["$route","$q","is","Restangular",function(e,n,t,o){var i=n.defer(),r=e.current.params.songId;return t.loading=!0,o.one("songs",r).get().then(function(e){t.loading=!1,i.resolve(e)},function(){t.loading=!1,i.reject()}),i.promise}]}}).otherwise({redirectTo:"/"});var s=OC.generateUrl("/apps/openlp");t.setBaseUrl(s)}]).run(["$rootScope","$location","SongsModel",function(e,t,o){n('link[rel="shortcut icon"]').attr("href",OC.filePath("songs","img","favicon.png")),e.$on("$routeChangeError",function(){var e=o.getAll();if(e.length>0){var n=e.sort(function(e,n){return e.modified>n.modified?1:e.modified<n.modified?-1:0}),i=e[n.length-1];t.path("/songs/"+i.id)}else t.path("/")})}]);s.controller("AppController",["$scope","$location","is",function(e,n,t){e.is=t,e.init=function(e){0!==e&&n.path("/songs/"+e)},e.search=""}]),s.controller("SongController",["$routeParams","$scope","SongsModel","SaveQueue","song","debounce",function(e,n,t,o,i,r){t.updateIfExists(i),n.song=t.get(e.songId),n.isSaving=function(){return o.isSaving()},n.updateTitle=function(){},n.save=r(function(){var e=n.song;o.add(e)},300),n.toggleDistractionFree=function(){function e(e){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}function n(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement?n():e(document.getElementById("app-content"))}}]),s.controller("SongsController",["$routeParams","$scope","$location","Restangular","SongsModel",function(e,n,t,o,i){n.route=e,n.songs=i.getAll();var r=o.all("songs");r.getList().then(function(e){i.addAll(e)}),n.create=function(){r.post().then(function(e){i.add(e),t.path("/songs/"+e.id)})},n["delete"]=function(e){var t=i.get(e);t.remove().then(function(){i.remove(e),n.$emit("$routeChangeError")})},n.toggleFavorite=function(e){var n=i.get(e);n.customPUT({favorite:!n.favorite},"favorite",{},{}).then(function(e){n.favorite=!!e})}}]),s.directive("songsAutofocus",function(){return{restrict:"A",link:function(e,n){n.focus()}}}),s.directive("editor",["$timeout","urlFinder",function(t,o){return{restrict:"A",link:function(r,s){var u=new i({element:s[0],spellChecker:!1,autoDownloadFontAwesome:!1,toolbar:!1,status:!1,forceSync:!0}),l=n(u.codemirror.getWrapperElement());u.value(r.song.content),u.codemirror.on("change",function(){t(function(){r.$apply(function(){r.song.content=u.value(),r.save(),r.updateTitle()})})}),l.on("click",".cm-link, .cm-url",function(n){if(n.ctrlKey){var t=o(this);e.isDefined(t)&&window.open(t,"_blank")}})}}}]),s.directive("songsIsSaving",["$window",function(e){return{restrict:"A",scope:{songsIsSaving:"="},link:function(n){e.onbeforeunload=function(){return n.songsIsSaving?t("songs","Song is currently saving. Leaving the page will delete all changes!"):null}}}}]),s.directive("songsTooltip",function(){return{restrict:"A",link:function(e,n){n.tooltip({container:"body"}),n.on("$destroy",function(){n.tooltip("hide")})}}}),s.filter("and",["$filter",function(e){return function(n,t){var o=t.split(" "),i=n;for(var r in o)i=e("filter")(i,o[r]);return i}}]),s.filter("songTitle",function(){return function(e){return e=e.split("\n")[0]||"newSong",e.trim().replace(/^#+/g,"")}}),s.factory("debounce",["$timeout",function(e){return function(n,t){var o;return function(){var i=this,r=arguments;o&&e.cancel(o),o=e(function(){n.apply(i,r)},t)}}}]),s.factory("is",function(){return{loading:!1}}),s.factory("SaveQueue",["$q",function(e){var n=function(){this._queue={},this._flushLock=!1};return n.prototype={add:function(e){this._queue[e.id]=e,this._flush()},_flush:function(){var n=Object.keys(this._queue);if(0!==n.length&&!this._flushLock){this._flushLock=!0;for(var t=this,o=[],i=0;i<n.length;i+=1){var r=this._queue[n[i]];o.push(r.put().then(this._songUpdateRequest.bind(null,r)))}this._queue={},e.all(o).then(function(){t._flushLock=!1,t._flush()})}},_songUpdateRequest:function(e,n){e.title=n.title,e.modified=n.modified},isSaving:function(){return this._flushLock}},new n}]),s.factory("SongsModel",function(){var n=function(){this.songs=[],this.songsIds={}};return n.prototype={addAll:function(e){for(var n=0;n<e.length;n+=1)this.add(e[n])},add:function(e){this.updateIfExists(e)},getAll:function(){return this.songs},get:function(e){return this.songsIds[e]},updateIfExists:function(n){var t=this.songsIds[n.id];e.isDefined(t)?(t.title=n.title,t.modified=n.modified,t.content=n.content,t.favorite=n.favorite):(this.songs.push(n),this.songsIds[n.id]=n)},remove:function(e){for(var n=0;n<this.songs.length;n+=1){var t=this.songs[n];if(t.id===e){this.songs.splice(n,1),delete this.songsIds[e];break}}}},new n}),s.factory("urlFinder",[function(){return function(e){for(e=n(e),e.is(".cm-url.cm-formatting")&&0!==e.prev().length&&(e=e.prev());e.is(".cm-link");)e=e.next();for(;e.is(".cm-url.cm-formatting");)e=e.next();return e.is(".cm-url:not(.cm-formatting)")?e.text():r}}])}(angular,jQuery,oc_requesttoken,SimpleMDE);
//# sourceMappingURL=app.min.js.map
