!function(n,e,o,i,r){"use strict";var s=n.module("OpenLP",["restangular","ngRoute"]).config(["$provide","$routeProvider","RestangularProvider","$httpProvider","$windowProvider",function(n,e,t,i,r){i.defaults.headers.common.requesttoken=o,n.value("Constants",{saveInterval:5e3}),e.when("/songs/:songId",{templateUrl:"song.html",controller:"SongController",resolve:{song:["$route","$q","is","Restangular",function(n,e,t,o){var i=e.defer(),r=n.current.params.songId;return t.loading=!0,o.one("songs",r).get().then(function(n){t.loading=!1,i.resolve(n)},function(){t.loading=!1,i.reject()}),i.promise}]}}).otherwise({redirectTo:"/"});var s=OC.generateUrl("/apps/openlp");t.setBaseUrl(s)}]).run(["$rootScope","$location","SongsModel",function(n,t,o){e('link[rel="shortcut icon"]').attr("href",OC.filePath("songs","img","favicon.png")),n.$on("$routeChangeError",function(){var n=o.getAll();if(n.length>0){var e=n.sort(function(n,e){return n.modified>e.modified?1:n.modified<e.modified?-1:0}),i=n[e.length-1];t.path("/songs/"+i.id)}else t.path("/")})}]);s.directive("songsAutofocus",function(){return{restrict:"A",link:function(n,e){e.focus()}}}),s.directive("editor",["$timeout","urlFinder",function(t,o){return{restrict:"A",link:function(r,s){var u=new i({element:s[0],spellChecker:!1,autoDownloadFontAwesome:!1,toolbar:!1,status:!1,forceSync:!0}),l=e(u.codemirror.getWrapperElement());u.value(r.song.content),u.codemirror.on("change",function(){t(function(){r.$apply(function(){r.song.content=u.value(),r.save(),r.updateTitle()})})}),l.on("click",".cm-link, .cm-url",function(e){if(e.ctrlKey){var t=o(this);n.isDefined(t)&&window.open(t,"_blank")}})}}}]),s.directive("songsIsSaving",["$window",function(n){return{restrict:"A",scope:{songsIsSaving:"="},link:function(e){n.onbeforeunload=function(){return e.songsIsSaving?t("songs","Song is currently saving. Leaving the page will delete all changes!"):null}}}}]),s.directive("songsTooltip",function(){return{restrict:"A",link:function(n,e){e.tooltip({container:"body"}),e.on("$destroy",function(){e.tooltip("hide")})}}}),s.controller("AppController",["$scope","$location","is",function(n,e,t){n.is=t,n.init=function(n){0!==n&&e.path("/songs/"+n)},n.search=""}]),s.controller("SongController",["$routeParams","$scope","SongsModel","SaveQueue","song","debounce",function(n,e,o,i,r,s){o.updateIfExists(r),e.song=o.get(n.songId),e.isSaving=function(){return i.isSaving()},e.updateTitle=function(){e.song.title=e.song.content.split("\n")[0]||t("songs","New song")},e.save=s(function(){var n=e.song;i.add(n)},300),e.toggleDistractionFree=function(){function n(n){n.requestFullscreen?n.requestFullscreen():n.mozRequestFullScreen?n.mozRequestFullScreen():n.webkitRequestFullscreen?n.webkitRequestFullscreen():n.msRequestFullscreen&&n.msRequestFullscreen()}function e(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement?e():n(document.getElementById("app-content"))}}]),s.controller("SongsController",["$routeParams","$scope","$location","Restangular","SongsModel",function(n,e,t,o,i){e.route=n,e.songs=i.getAll();var r=o.all("songs");r.getList().then(function(n){i.addAll(n)}),e.create=function(){r.post().then(function(n){i.add(n),t.path("/songs/"+n.id)})},e["delete"]=function(n){var t=i.get(n);t.remove().then(function(){i.remove(n),e.$emit("$routeChangeError")})},e.toggleFavorite=function(n){var e=i.get(n);e.customPUT({favorite:!e.favorite},"favorite",{},{}).then(function(n){e.favorite=!!n})}}]),s.filter("and",["$filter",function(n){return function(e,t){var o=t.split(" "),i=e;for(var r in o)i=n("filter")(i,o[r]);return i}}]),s.filter("songTitle",function(){return function(n){return n=n.split("\n")[0]||"newSong",n.trim().replace(/^#+/g,"")}}),s.filter("wordCount",function(){return function(n){if(n&&"string"==typeof n){var e=n.split(/\s+/).filter(function(n){return n.search(/[A-Za-z0-9]/)!==-1}).length;return window.n("songs","%n word","%n words",e)}return 0}}),s.factory("debounce",["$timeout",function(n){return function(e,t){var o;return function(){var i=this,r=arguments;o&&n.cancel(o),o=n(function(){e.apply(i,r)},t)}}}]),s.factory("is",function(){return{loading:!1}}),s.factory("SaveQueue",["$q",function(n){var e=function(){this._queue={},this._flushLock=!1};return e.prototype={add:function(n){this._queue[n.id]=n,this._flush()},_flush:function(){var e=Object.keys(this._queue);if(0!==e.length&&!this._flushLock){this._flushLock=!0;for(var t=this,o=[],i=0;i<e.length;i+=1){var r=this._queue[e[i]];o.push(r.put().then(this._songUpdateRequest.bind(null,r)))}this._queue={},n.all(o).then(function(){t._flushLock=!1,t._flush()})}},_songUpdateRequest:function(n,e){n.title=e.title,n.modified=e.modified},isSaving:function(){return this._flushLock}},new e}]),s.factory("SongsModel",function(){var e=function(){this.songs=[],this.songsIds={}};return e.prototype={addAll:function(n){for(var e=0;e<n.length;e+=1)this.add(n[e])},add:function(n){this.updateIfExists(n)},getAll:function(){return this.songs},get:function(n){return this.songsIds[n]},updateIfExists:function(e){var t=this.songsIds[e.id];n.isDefined(t)?(t.title=e.title,t.modified=e.modified,t.content=e.content,t.favorite=e.favorite):(this.songs.push(e),this.songsIds[e.id]=e)},remove:function(n){for(var e=0;e<this.songs.length;e+=1){var t=this.songs[e];if(t.id===n){this.songs.splice(e,1),delete this.songsIds[n];break}}}},new e}),s.factory("urlFinder",[function(){return function(n){for(n=e(n),n.is(".cm-url.cm-formatting")&&0!==n.prev().length&&(n=n.prev());n.is(".cm-link");)n=n.next();for(;n.is(".cm-url.cm-formatting");)n=n.next();return n.is(".cm-url:not(.cm-formatting)")?n.text():r}}])}(angular,jQuery,oc_requesttoken,SimpleMDE);
//# sourceMappingURL=app.min.js.map
